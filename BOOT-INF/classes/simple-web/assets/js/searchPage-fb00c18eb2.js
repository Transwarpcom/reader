function _slicedToArray(r,e){return _arrayWithHoles(r)||_iterableToArrayLimit(r,e)||_unsupportedIterableToArray(r,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(r,e){var t;if(r)return"string"==typeof r?_arrayLikeToArray(r,e):"Map"===(t="Object"===(t={}.toString.call(r).slice(8,-1))&&r.constructor?r.constructor.name:t)||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,e):void 0}function _arrayLikeToArray(r,e){(null==e||e>r.length)&&(e=r.length);for(var t=0,n=Array(e);t<e;t++)n[t]=r[t];return n}function _iterableToArrayLimit(r,e){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var n,a,i,o,u=[],l=!0,s=!1;try{if(i=(t=t.call(r)).next,0===e){if(Object(t)!==t)return;l=!1}else for(;!(l=(n=i.call(t)).done)&&(u.push(n.value),u.length!==e);l=!0);}catch(r){s=!0,a=r}finally{try{if(!l&&null!=t.return&&(o=t.return(),Object(o)!==o))return}finally{if(s)throw a}}return u}}function _arrayWithHoles(r){if(Array.isArray(r))return r}var _observers=[],_isObserveSignal=!0;function createEffect(r){function e(){_observers.push(e);try{r()}finally{_observers.pop()}}e()}function untrack(r){return function(){_isObserveSignal=!1;try{return r()}finally{_isObserveSignal=!0}}()}function createSignal(r,e){var t={equals:!1},n=((e=e||t).equals=(e.hasOwnProperty("equals")?e:t).equals,{value:r,subscribers:new Set,comparator:e.equals||void 0});return[readSignal.bind(n),function(r){return"function"==typeof r&&(r=r(n.value)),writeSignal(n,r)}]}function readSignal(){var r;return _isObserveSignal&&(r=_observers[_observers.length-1])&&this.subscribers.add(r),this.value}function writeSignal(r,e){return r.comparator&&r.comparator(r.value,e)||(r.value=e,r.subscribers.forEach(function(r){return r()})),e}function createMemo(r){var e=_slicedToArray(createSignal(),2),t=e[0],n=e[1];return createEffect(function(){return n(r())}),t}
function _typeof(o){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o})(o)}function _slicedToArray(o,e){return _arrayWithHoles(o)||_iterableToArrayLimit(o,e)||_unsupportedIterableToArray(o,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,e){var r;if(o)return"string"==typeof o?_arrayLikeToArray(o,e):"Map"===(r="Object"===(r={}.toString.call(o).slice(8,-1))&&o.constructor?o.constructor.name:r)||"Set"===r?Array.from(o):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(o,e):void 0}function _arrayLikeToArray(o,e){(null==e||e>o.length)&&(e=o.length);for(var r=0,t=Array(e);r<e;r++)t[r]=o[r];return t}function _iterableToArrayLimit(o,e){var r=null==o?null:"undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(null!=r){var t,n,a,i,c=[],s=!0,u=!1;try{if(a=(r=r.call(o)).next,0===e){if(Object(r)!==r)return;s=!1}else for(;!(s=(t=a.call(r)).done)&&(c.push(t.value),c.length!==e);s=!0);}catch(o){u=!0,n=o}finally{try{if(!s&&null!=r.return&&(i=r.return(),Object(i)!==i))return}finally{if(u)throw n}}return c}}function _arrayWithHoles(o){if(Array.isArray(o))return o}var _createSignal=createSignal(!1),_createSignal2=_slicedToArray(_createSignal,2),isSearching=_createSignal2[0],setIsSearching=_createSignal2[1],_createSignal3=createSignal([]),_createSignal4=_slicedToArray(_createSignal3,2),searchBookList=_createSignal4[0],setSearchBookList=_createSignal4[1],_createSignal5=createSignal([]),_createSignal6=_slicedToArray(_createSignal5,2),bookSourceList=_createSignal6[0],setBookSourceList=_createSignal6[1],_createSignal7=createSignal([]),_createSignal8=_slicedToArray(_createSignal7,2),bookShelfList=_createSignal8[0],setBookShelfList=_createSignal8[1],_createSignal9=createSignal(null),_createSignal10=_slicedToArray(_createSignal9,2),bookInfo=_createSignal10[0],setBookInfo=_createSignal10[1],bookListContainer=$("#bookList"),pagination=new Pagination,searchConfig=null,bookSourceGroupList=(window.hasSearched=!1,[]);function onSearchBookListPageChange(o){o===pagination.pageCount&&searchConfig&&!searchConfig.isEnd&&(searchConfig.page+=1,searchBookWithConfig(searchConfig))}function search(){var o=$("#keyword").val();o?searchBook(o):showNotice("请输入关键字")}function searchBookWithSourceIndex(o){closeTip(),searchBook($("#keyword").val(),o)}function searchBook(o,e){isSearching()||(searchConfig=getSearchConfig(o,e))&&(window.hasSearched=!0,setSearchBookList([]),setIsSearching(!0),searchBookWithConfig(searchConfig))}function searchBookWithConfig(a){(a.isMulti&&0===a.lastIndex||!a.isMulti&&1===a.page)&&(pagination.page=1),$.ajax.post(a.isMulti?"/searchBookMulti":"/searchBook",{key:a.key,bookSourceUrl:a.bookSourceUrl,bookSourceGroup:a.bookSourceGroup,concurrentCount:a.concurrentCount,lastIndex:a.lastIndex,page:a.page},function(o){var e,r,t,n;(o=JSON.parse(o)).isSuccess&&(e=[],e=a.isMulti?(searchConfig.lastIndex=o.data.lastIndex,o.data.list):o.data,r=[],(1<a.page||0<a.lastIndex)&&(r=[].concat(searchBookList())),t={},n=r.reduce(function(o,e){return o[e.name+"_"+e.author]=e,t[e.bookUrl]=e,o},{}),o=r.length,e.forEach(function(o){t[o.bookUrl]||(n[o.name+"_"+o.author]?(n[o.name+"_"+o.author].sourceCount=n[o.name+"_"+o.author].sourceCount||1,n[o.name+"_"+o.author].sourceCount+=1):(o.sourceCount=1,n[o.name+"_"+o.author]=o,r.push(o)))}),setSearchBookList(r),r.length===o)&&(searchConfig.isEnd=!0),setIsSearching(!1)})}function getSearchConfig(o,e){var r={};if(o){if(r.isMulti=!0,r.bookSourceGroup="",r.key=o,r.concurrentCount=4,r.page=1,r.lastIndex=0,r.isEnd=!1,0<o.indexOf("#")){if(r.bookSourceGroup=0<o.indexOf("#")?o.split("#")[0]:"",r.key=0<o.indexOf("#")?o.split("#")[1]:o,!r.bookSourceGroup)return r;var t=bookSourceGroupList.filter(function(o){return 0<=o.name.indexOf(r.bookSourceGroup)||0<=o.value.indexOf(r.bookSourceGroup)});if(!t||t.length<1)return void showNotice("未匹配到书源分组: "+r.bookSourceGroup);if(t&&1<t.length)return null!=_typeof(e)&&0<=e&&e<t.length?(r.bookSourceGroup=t[e].value,r):void renderTmpl("searchSourceList",{list:t,keyword:r.key,isSourceGroup:!0},function(o){showTip("请选择书源分组","关闭","<div style='flex: 1'>"+o+"</div>")});r.bookSourceGroup=t[0].value}else if(0<o.indexOf("@")){r.isMulti=!1,r.key=o.split("@")[1];var n=o.split("@")[0],t=bookSourceList().filter(function(o){return 0<=o.bookSourceName.indexOf(n)||0<=o.bookSourceUrl.indexOf(n)});if(!t||t.length<1)return void showNotice("未匹配到书源: "+n);if(t&&1<t.length)return null!=_typeof(e)&&0<=e&&e<t.length?(r.bookSourceUrl=t[e].bookSourceUrl,r):void renderTmpl("searchSourceList",{list:t,keyword:r.key,isSourceGroup:!1},function(o){showTip("请选择书源","关闭","<div style='flex: 1'>"+o+"</div>")});r.bookSourceUrl=t[0].bookSourceUrl}return r}}function showBookInfo(e){var o,r=searchBookList()[e];(r=r||searchBookList().find(function(o){return o.bookUrl=e}))&&(o=bookShelfList().find(function(o){return o.bookUrl===r.bookUrl}),r.isInShelf=!!o,setBookInfo(r))}function saveBook(){var o=bookInfo();o&&o.bookUrl&&o.name&&o.author?$.ajax.post("/saveBook",o,function(o){(o=JSON.parse(o)).isSuccess&&(showNotice("加入成功"),loadBookShelfList(function(){showBookInfo(bookInfo().bookUrl)}))},!0):showNotice("书籍信息错误")}function refreshChapterList(e){var o=searchBookList().find(function(o){return o.bookUrl===e});o&&$.ajax.post("/getChapterList",{url:o.bookUrl,bookSourceUrl:o.origin},function(e){(e=JSON.parse(e)).isSuccess&&setBookInfo(function(o){return o.totalChapterNum=e.data.length,o.latestChapterTitle=e.data[e.data.length-1].title,o})},!0)}createEffect(function(){renderTmpl("bookList",{list:searchBookList(),isLoading:isSearching(),isSearch:!0},function(o){bookListContainer.html(""),bookListContainer.append(o);o=pagination.page;pagination.init(".book-info",0,"#bookList",onSearchBookListPageChange,o)})}),createEffect(function(){var o=searchBookList();"string"!=typeof o?$("#bookNum").html("("+o.length+")"):$("#bookNum").html("(0)")}),createEffect(function(){var e=bookInfo();e&&renderTmpl("bookInfo",{bookInfo:e,isSearch:!0,encodeBookUrl:encodeURIComponent(e.bookUrl)},function(o){showTip(e.name,"关闭",o)})});var sourceListWatcher=new Watcher;function changeSource(e){var r=searchBookList().find(function(o){return o.bookUrl===e});r&&((sourceListWatcher=new Watcher).onChange(function(o){"loading"===o?showTip(r.name+"("+r.originName+")","关闭",'<div style="text-align: center;">\n    <b>书源加载中...请稍后...(时间较长)</b>\n</div>'):"error"===o?showTip(r.name+"("+r.originName+")","关闭",'<div style="text-align: center;">\n    <b>抱歉，找不到该书籍,请稍后再试！</b>\n</div>'):o&&0!==o.length?renderTmpl("sourceList",{bookUrl:e,list:o},function(o){showTip(r.name+"("+r.originName+")","关闭","<div style='flex: 1'>"+o+"</div>")}):showTip(r.name+"("+r.originName+")","关闭",'<div style="text-align: center;">\n    <b onclick=\'loadMoreBookSource("'+e+"\")'>加载更多书源</b>\n</div>")},!0),sourceListWatcher.update("loading"),$.ajax.post("/getAvailableBookSource",{url:e},function(o){try{(o=JSON.parse(o)).isSuccess?sourceListWatcher.update(o.data):sourceListWatcher.update("error")}catch(o){sourceListWatcher.update("error")}},!0))}function loadBookSourceList(){$.ajax.get("/getBookSources?simple=1",function(o){if((o=JSON.parse(o)).isSuccess){setBookSourceList(o.data);var e,r={},t=(o.data.forEach(function(o){o.bookSourceGroup&&o.bookSourceGroup.split(",").forEach(function(o){r[o]=1+(0|r[o])})}),[{name:"全部分组",value:"",count:o.data.length}]);for(e in r)Object.hasOwnProperty.call(r,e)&&t.push({name:e,value:e,count:r[e]});bookSourceGroupList=t}})}function loadBookShelfList(e){$.ajax.get("/getBookshelf",function(o){(o=JSON.parse(o)).isSuccess&&(setBookShelfList(o.data),e)&&e()})}onMounted(function(){(new Menu).initMenu(),isLoginWatcher.onChange(loadBookSourceList,!0),$("#keyword").on("keyup",function(o){"Enter"===o.key&&search()})});