var pagination=new Pagination,bookApi=new BookApi,showBookListWatcher=new Watcher([]);function contains(o,e){return o&&0<=o.indexOf(e)}function onKeywordChange(){computeShowBookList()}function computeShowBookList(){var o=$("#keyword").val().replace(/^\s+/g,"").replace(/\s+$/g,""),e=(e=bookListWatcher.getValue()).sort(function(o,e){o=o.durChapterTime||0;return(e.durChapterTime||0)-o});if(o)if(e&&0<e.length){for(var t=[],n=0;n<e.length;n++){var a=e[n];(contains(a.name,o)||contains(a.author,o)||contains(a.kind,o))&&t.push(a)}showBookListWatcher.update(t)}else showBookListWatcher.update([]);else showBookListWatcher.update(e)}function onPageInit(){bookApi.getBookshelf();var e=$("#booklist");showBookListWatcher.onChange(function(o){o&&0<o.length?(renderTmpl("bookList",{list:o,isLoading:!1,isSearch:!1},function(o){e.html(""),e.append(o),pagination.init(".book-info",0)}),$("#bookNum").text("("+o.length+")")):($("#bookNum").text("(0)"),e.html(""),e.append("<div  style='font-size: 1.6em;margin-top: 140px;text-align: center' >\n        书架为空，请用其他浏览器搜索添加书籍\n</div>"))},!0)}bookListWatcher.onChange(function(){computeShowBookList()});var bookInfoWatcher=new Watcher;function showBookInfo(o){bookInfoWatcher.onChange(function(o){renderTmpl("bookInfo",{bookInfo:o,isSearch:!1,encodeBookUrl:encodeURIComponent(o.bookUrl)},function(o){showTip(e.name,"关闭",o)})});var e=showBookListWatcher.getValue()[o];bookInfoWatcher.update(e)}function refreshChapterList(o){$.ajax.post("/getChapterList",{url:o},function(o){var e;(o=JSON.parse(o)).isSuccess&&((e=bookInfoWatcher.getValue()).totalChapterNum=o.data.length,e.latestChapterTitle=o.data[o.data.length-1].title,bookInfoWatcher.update(e),bookApi.updateBook(e))},!0)}var sourceListWatcher=new Watcher;function changeSource(e){var t=bookApi.getBookInfoByUrl(e);sourceListWatcher.onChange(function(o){"loading"===o?showTip(t.name+"("+t.originName+")","关闭",'<div style="text-align: center;">\n    <b>书源加载中...请稍后...(时间较长)</b>\n</div>'):"error"===o?showTip(t.name+"("+t.originName+")","关闭",'<div style="text-align: center;">\n    <b>抱歉，找不到该书籍,请稍后再试！</b>\n</div>'):o&&0!==o.length?renderTmpl("sourceList",{bookUrl:e,list:o},function(o){showTip(t.name+"("+t.originName+")","关闭","<div style='flex: 1'>"+o+"</div>")}):showTip(t.name+"("+t.originName+")","关闭",'<div style="text-align: center;">\n    <b onclick=\'loadMoreBookSource("'+e+"\")'>加载更多书源</b>\n</div>")},!0),sourceListWatcher.update("loading"),$.ajax.post("/getAvailableBookSource",{url:e},function(o){try{(o=JSON.parse(o)).isSuccess?sourceListWatcher.update(o.data):sourceListWatcher.update("error")}catch(o){sourceListWatcher.update("error")}},!0)}(new Menu).initMenu(),isLoginWatcher.onChange(onPageInit,!0);